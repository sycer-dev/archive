<!DOCTYPE html>

<html>

<head>
    <meta charset="UTF-8">
    <title>sycerSMS</title>
    <meta name="author" content="Fyko">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name='viewport' content='width=device-width, initial-scale=1'>

    <!-- Metadata -->
    <link rel="apple-touch-icon" sizes="180x180" href="/public/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/public/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/public/favicon-16x16.png">
    <link rel="manifest" href="/public/site.webmanifest">
    <meta name="msapplication-TileColor" content="#36393f">
    <meta name="theme-color" content="#36393f">

    <meta name="theme-color" content="#36393f">
    <meta name="apple-mobile-web-app-title" content="sycerSMS">
    <link rel="canonical" href="https://sms.sycer.dev/">

    <!-- Embed Data -->
    <meta name="author" content="sycerSMS">
    <meta name="description" content="Deliver time sensitive alerts with sycerSMS">

    <meta property="og:type" content="website">
    <meta property="og:site_name" content="sycerSMS">
    <meta property="og:title" content="sycerSMS">
    <meta property="og:description" content="Deliver time sensitive alerts with sycerSMS.">
    <meta property="og:url" content="https://sms.sycer.dev/">
    <meta property="og:image" content="/public/android-chrome-512x512.png">

    <!-- Design -->
    <script src="https://js.stripe.com/v3"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css">
    <script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.0/jquery.min.js></script>
    <link href="https://unpkg.com/caramel@2.0.0-beta/dist/css/caramel.min.css" rel="stylesheet">
    <script src="/public/sweetalert.min.js"></script>
    <link href="//cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@3/dark.css" rel="stylesheet">

    <style>
        body {
            background-color: #2C2F33;
            color: white;
        }

        .card {
            margin: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            width: 600px;
        }

        .textbox {
            background-color: #34354A;
            color: #6C6E92;
            width: 300px;
        }
    </style>
</head>

<body onload="onload()">
	<main class="main">
        <div class="center">
            <div class="row">
                <div class="box col-12">
                    <div class="card">
                        <div id="content" class="content">
							<h3 style="font-weight: 900;"><%= server.name %></h3>
                            <h6 style="text-align: center; margin-top: -15px;"><a href="/@me">â¬… Go back</a></h6>
                            <hr>
                            <h4>Subscription Information</h4>
                            <h5>
                                Your plan <%= sub.cancel_at_period_end ? 'ends' : 'renews'%> on
                                <%= new Date(Date.now() + sub.current_period_end + sub.current_period_start).toLocaleString('en-US', { month: 'long', year: 'numeric', day: 'numeric' });  %>
                                - <i class="fab fa-cc-<%= sub.default_payment_method.card.brand%>"></i> <%= sub.default_payment_method.card.last4 %>
                                <br>$<%= sub.plan.amount / 100 %> per month
                                <br><br>
                                <button class="dark" onclick="window.open('<%= inviteURL %>', '_blank')" style="background-color: #9400D3;">
                                    <i class="fas fa-link"></i> Invite Bot
                                </button>
                                <button class="dark" id="manage-sub" onclick="manageSub()" style="background-color: #9400D3;">
                                    <i class="fas fa-wallet"></i> Manage Subscription 
                                </button>
                            </h5>
                            <hr>
                            <h4>Twilio Settings</h4>
                            <label for="sid" style="font-weight: bold; text-align: left;">Account ID</label><br>
                            <input class="textbox" type="text" id="sid" name="sid" value="<%= twilio.sid %>"><br>

                            <label for="token" style="font-weight: bold; text-align: left;">Account Token</label><br>
                            <input class="textbox" type="password" id="token" name="token" value="<%= twilio.token %>"><br>

                            <label for="notify" style="font-weight: bold; text-align: left;">Notify Service ID</label><br>
                            <input class="textbox" type="text" id="notify" name="notify" value="<%= twilio.notify %>"><br>

                            <label for="verify" style="font-weight: bold; text-align: left;">Verify Service ID</label><br>
                            <input class="textbox" type="text" id="verify" name="verify" value="<%= twilio.verify %>"><br>

                            <h5>
                                <button class="dark" id="patch-twilio" onclick="patchTwilioSettings()" style="background-color: #008315;">
                                    <i class="fas fa-cog"></i> Save Changes 
                                </button>
                            </h5>
                            <hr>
                            <small>
                                &copy; Sycer Development LLC. - 
                                <a href="https://discord.gg/wGZ6SVaeW7" target="_blank">Support Server</a> - 
                                <a href="https://github.com/sycer-dev/terms/blob/master/README.md" target="_blank">Legal</a> - 
                                <a href="/logout">Logout</a>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
    <script src="https://unpkg.com/caramel@2.0.0-beta/dist/js/caramel.min.js"></script>

    <script>
        const stripe = Stripe('<%= STRIPE_PUBLIC_KEY %>');

        async function patchTwilioSettings() {
            const button = document.getElementById('patch-twilio');
            button.disabled = true;
            button.autocomplete = 'off';
            button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Save Changes';

            function unlock() {
                button.disabled = false;
                button.autocomplete = '';
                button.innerHTML = '<i class="fas fa-cog"></i> Save Changes';
            }

            const sid = document.getElementById('sid').value;
            const token = document.getElementById('token').value;
            const notify = document.getElementById('notify').value;
            const verify = document.getElementById('verify').value;
            if (!sid && !token && !notify && !verify) return unlock();
            
            const res = await fetch(`/api/twilio/<%= server.id %>`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sid, token, notify, verify }) });
            const json = await res.json();
            unlock();

            if (json.type === 'error') {
                return swal({
                    icon: 'error',
                    title: 'An error occurred!',
                    text: json.message,
                });
            } else {
                return swal({
                    text: 'Successfully updated your Twilio settings!'
                })
            }
        }

        async function manageSub() {
            const button = document.getElementById('manage-sub');
            button.disabled = true;
            button.autocomplete = 'off';
            button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Manage Subscription ';

            const res = await fetch(`/api/billing/<%= server.id %>`, { method: 'PATCH' });
            const url = await res.text();

            return window.location = url;
        }

        function onload() { return; }
    </script>
</body>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-151946240-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', 'UA-151946240-1');
</script>

</html>
